---
title: IIC调试
date: 2017-01-06 17:03:21
tags: 
	- 软件调试
---
**故障描述：**

- 防近视传感器em30917中IIC 一直通讯不成功，抓取波形发现，注意没有发送停止信号
<!-- more -->
![enter description here][1]
**工具准备：**

- PC模拟逻辑分析仪： 方便抓取波形，并解析波形,版本：  Logic Setup 1.2.11

**IIC描述:** 

- IIC总线只需要两条线，一条SDA数据线，一条SCL时钟线；根据这两条线的高低电平、上升沿、下降沿就可以实现主机与I2C设备的通讯
- 每一个IIC设备都有一个唯一的7位或10位设备地址
	-  任何IIC设备都有一个7位地址，理论上，现实中只能有127种不同的IIC设备。实际上，已有IIC的设备种类远远多于这个限制，在一条总线上出现相同的地址的IIC设备的概率相当高。为了突破这个限制，很多设备使用了双重地址——7位地址加引脚地址。IIC 标准也预知了这种限制，提出10位的地址方案。
- 数据帧大小为8位的字节
- 数据（帧）中的某些数据位用于控制通信的开始、停止、方向（读写）和应答机制。
- IIC 数据传输速率有标准模式（100 kbps）、快速模式（400 kbps）和高速模式（3.4 Mbps），另外一些变种实现了低速模式（10 kbps）和快速+模式（1 Mbps）。
- 通讯过程
	- 首先主设备发送一个开始信号，这个信号就像对所有设备喊：请大家注意！然后其它设备开始监听总线准备接收数据。然后，主设备发送一个7位设备地址加一位的读写操作的数据帧。当所有设备接收数据后，对比地址自己是否目标设备。如果对比不符，设备进入等待状态，等待停止信号的来临；如果对比相符，从设备会发送一个应答信号（ACK）进行回应

	- 当主设备收到应答后便开始传送或接收数据。数据帧大小为8位，尾随一位应答信号。主设备发送数据，从设备应答；相反主设备接数据，主设备应答。当数据传送完毕，主设备发送一个停止信号，向其它设备宣告释放总线，其它设备回到初始状态
	- 正常I2C总线的数据：`Start + I2C devece id + R/W + ACK + Data（first byte）+ ACK + ... + Data（n）+ ACK + Stop`
- 开始和结束信号： 
	- 基于IIC总线的物理结构，总线上的START和STOP信号必定是唯一的。另外，IIC总线标准规定SDA线的数据转换必须在SCL线的低电平期，在SCL线的高电平期，SDA线的上数据是稳定的
	- ![enter description here][2]

**波形分析:**

-   ![enter description here][3]
-  （其中黄色的为SDA信号，浅蓝色为SCL信号）：从上述波形中我们可以读取到数据依次是：01111000 0 00000000 101011100；即：0111100(7位OLED设备地址) + 0( 读写为，0为写，1为读)+0（ACK回应）+00000000（寄存器reg）+ 10101110(0xAE OLED off命令)

**参考链接：**

 1. http://blog.csdn.net/skyflying2012/article/details/11910173
 2. http://www.xuebuyuan.com/848622.html


  [1]: http://oimqf80rv.bkt.clouddn.com/IIC-1.png
  [2]: http://oimqf80rv.bkt.clouddn.com/IIC-2.png
  [3]: http://oimqf80rv.bkt.clouddn.com/IIC-3.png